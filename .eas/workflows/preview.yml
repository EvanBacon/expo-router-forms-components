name: PR Preview

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  publish:
    type: custom
    image: latest
    outputs:
      update_output: ${{ steps.update.outputs.update_output }}
    steps:
      - name: ğŸ—„ï¸ Setup project
        uses: eas/checkout

      - name: ğŸ“¦ Install dependencies
        uses: eas/install_node_modules

      - name: ğŸš€ Publish update
        id: update
        run: |
          OUTPUT=$(npx eas-cli update --branch "pr-${{ github.event.pull_request.number }}" --message "${{ github.event.pull_request.title }}" --json --non-interactive)
          set-output update_output "$OUTPUT"

  comment:
    type: github-comment
    needs: [publish]
    params:
      payload: |
        ğŸ“± **Preview is ready!**

        Open in Expo Go:
        [**exp://u.expo.dev/update/${{ fromJSON(needs.publish.outputs.update_output)[0].group }}**](${{ replace(fromJSON(needs.publish.outputs.update_output)[0].manifestPermalink, 'https://', 'exp://') }})

        [View on Dashboard](${{ fromJSON(needs.publish.outputs.update_output)[0].manifestPermalink }})
